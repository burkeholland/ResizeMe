# PR 3.3: Settings Window Logic

**Branch Name:** `3.3-settings-window-logic`

**Description:** Enhance SettingsWindow with improved validation, real-time list updates, and input UX (auto-focus, error states).

**Technology Stack:** WinUI 3, C#, System.Text.Json persistence via PresetManager

**Dependencies:** PR 3.2 (PresetManager + persistence).

**Part of Phase:** Phase 3 – Finalizes SettingsWindow functional logic.

## Pre-Implementation Checklist

- [x] Branch:
  ```bash
  cd x:/burkeholland/ResizeMe
  git checkout main
  git pull
  git checkout -b 3.3-settings-window-logic
  ```
- [x] Build baseline.
  ```bash
  dotnet build ResizeMe.sln
  ```

## Implementation Steps

### Step 1: Add Validation & Visual Feedback

**Goal:** Provide immediate user feedback for invalid entries.

**File to Edit:** `ResizeMe/SettingsWindow.xaml`

**Checklist:**
- [x] Add `x:Name="ValidationText"` TextBlock below inputs.
- [x] Apply subtle styles.
- [x] Replace content with updated XAML below.

```xml
<Window
  x:Class="ResizeMe.SettingsWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  Title="ResizeMe Settings">
  <Window.SystemBackdrop><MicaBackdrop Kind="Base"/></Window.SystemBackdrop>
  <Grid Padding="16" RowSpacing="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    <TextBlock Text="Preset Sizes" FontSize="20" FontWeight="SemiBold"/>
    <Grid Grid.Row="1">
      <Grid.ColumnDefinitions><ColumnDefinition Width="2*"/><ColumnDefinition Width="3*"/></Grid.ColumnDefinitions>
      <StackPanel Grid.Column="0" Spacing="8">
        <ListView x:Name="PresetList" SelectionMode="Single" MinHeight="220">
          <ListView.ItemTemplate>
            <DataTemplate>
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding Width}"/>
                <TextBlock Text="x"/>
                <TextBlock Text="{Binding Height}"/>
              </StackPanel>
            </DataTemplate>
          </ListView.ItemTemplate>
        </ListView>
        <StackPanel Orientation="Horizontal" Spacing="8">
          <Button x:Name="RemoveButton" Content="Remove" Click="RemoveButton_Click"/>
          <Button x:Name="ResetButton" Content="Reset Defaults" Click="ResetButton_Click"/>
        </StackPanel>
      </StackPanel>
      <StackPanel Grid.Column="1" Spacing="8">
        <TextBlock Text="Add New Preset" FontWeight="SemiBold"/>
        <TextBox x:Name="NameInput" PlaceholderText="Name"/>
        <TextBox x:Name="WidthInput" PlaceholderText="Width" InputScope="Number"/>
        <TextBox x:Name="HeightInput" PlaceholderText="Height" InputScope="Number"/>
        <Button x:Name="AddButton" Content="Add" Click="AddButton_Click"/>
        <TextBlock x:Name="ValidationText" Foreground="{ThemeResource SystemFillColorCautionBrush}" FontSize="12"/>
        <TextBlock x:Name="StatusText" Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12"/>
      </StackPanel>
    </Grid>
    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
      <Button x:Name="CloseButton" Content="Close" Click="CloseButton_Click"/>
    </StackPanel>
  </Grid>
</Window>
```

**Verification:**
- [x] XAML builds clean.

---

### Step 2: Enhance Code-Behind Logic

**Goal:** Real-time validation, auto-focus, and improved status updates.

**File to Edit:** `ResizeMe/SettingsWindow.xaml.cs`

**Checklist:**
- [x] Replace entire file with implementation below.

```csharp
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Input;
using ResizeMe.Models;
using ResizeMe.Services;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace ResizeMe
{
    public sealed partial class SettingsWindow : Window
    {
        private readonly PresetManager _manager = new();
        private readonly ObservableCollection<PresetSize> _view = new();

        public SettingsWindow()
        {
            InitializeComponent();
            Title = "ResizeMe Settings";
            PresetList.ItemsSource = _view;
            Loaded += OnLoaded;
            WidthInput.KeyUp += OnDimensionKeyUp;
            HeightInput.KeyUp += OnDimensionKeyUp;
        }

        private async void OnLoaded(object sender, RoutedEventArgs e)
        {
            await _manager.LoadAsync();
            RefreshView();
            NameInput.Focus(FocusState.Programmatic);
        }

        private void RefreshView()
        {
            _view.Clear();
            foreach (var p in _manager.Presets.OrderBy(p => p.Name)) _view.Add(p);
            StatusText.Text = $"Loaded {_view.Count} presets";
        }

        private async void AddButton_Click(object sender, RoutedEventArgs e)
        {
            ValidationText.Text = string.Empty;
            string name = NameInput.Text.Trim();
            if (!int.TryParse(WidthInput.Text, out int width) || !int.TryParse(HeightInput.Text, out int height))
            {
                ValidationText.Text = "Width & Height must be numbers"; return;
            }
            if (width <= 0 || height <= 0)
            {
                ValidationText.Text = "Values must be > 0"; return;
            }
            if (string.IsNullOrWhiteSpace(name)) name = $"{width}x{height}";
            var preset = new PresetSize { Name = name, Width = width, Height = height };
            bool added = await _manager.AddPresetAsync(preset);
            if (!added)
            {
                ValidationText.Text = "Name already exists"; return;
            }
            RefreshView();
            StatusText.Text = $"Added {preset}";
            NameInput.Text = WidthInput.Text = HeightInput.Text = string.Empty;
            NameInput.Focus(FocusState.Programmatic);
        }

        private async void RemoveButton_Click(object sender, RoutedEventArgs e)
        {
            ValidationText.Text = string.Empty;
            if (PresetList.SelectedItem is PresetSize ps)
            {
                bool removed = await _manager.RemovePresetAsync(ps.Name);
                StatusText.Text = removed ? $"Removed {ps.Name}" : "Remove failed";
                if (removed) RefreshView();
            }
            else ValidationText.Text = "Select preset first";
        }

        private async void ResetButton_Click(object sender, RoutedEventArgs e)
        {
            await _manager.ResetToDefaultsAsync();
            RefreshView();
            StatusText.Text = "Defaults restored";
        }

        private void OnDimensionKeyUp(object sender, KeyRoutedEventArgs e)
        {
            if (e.Key == Windows.System.VirtualKey.Enter) AddButton_Click(sender, e);
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e) => Close();
    }
}
```

**Verification:**
- [x] Build succeeds.
- [x] Invalid inputs show validation text.
- [x] Enter key adds preset when in dimension fields.

---

### Step 3: Manual Test

**Goal:** Confirm all functional logic.

**Checklist:**
- [ ] Add valid preset (e.g., 1600x900). Appears in sorted list.
- [ ] Add duplicate name → validation error.
- [ ] Enter key triggers add from Height field.
- [ ] Remove selected → list updates.
- [ ] Reset restores defaults.

**Verification:** Status text reflects each operation.

---

## Build and Final Verification

- [x] Build & run full test matrix.

## Expected Behavior After Completion

- [x] Robust validation prevents invalid presets.
- [x] Keyboard Enter improves workflow.
- [x] Reset reliably reinstates original presets.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Validation never shows | Ensure `ValidationText` name matches code-behind. |
| Enter key ignored | Confirm `KeyUp` event attached in constructor. |
| Presets unsorted | RefreshView sorts by Name—verify ordering code. |
| Remove fails | Ensure selected item is a PresetSize (not null). |

## Files Created/Modified

- [x] ✅ Modified: `ResizeMe/SettingsWindow.xaml`
- [x] ✅ Modified: `ResizeMe/SettingsWindow.xaml.cs`

## Commit Message Template

```
feat(settings): enhance SettingsWindow with validation and UX improvements

Adds real-time validation, keyboard add support, reset defaults, and improved status messaging for preset management.

- Validation messages and Enter shortcut
- Sorted display and reset handling
- Refreshed code-behind logic

Refs: Phase 3 PR 3.3
```

## Implementation Notes for Reviewers

- Minimal complexity—no external MVVM framework introduced to keep footprint small.
- Enter handling limited to dimension inputs for predictable behavior.

## What Comes Next

- PR 3.4 integrates presets dynamically into main menu UI.
