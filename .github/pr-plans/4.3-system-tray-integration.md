# PR 4.3: System Tray Integration

**Branch Name:** `4.3-system-tray-integration`

**Description:** Add system tray (notification area) icon with context menu (Show/Hide, Settings, Exit).

**Technology Stack:** Win32 Shell_NotifyIcon P/Invoke, WinUI 3, C#.

**Dependencies:** Prior Phase 4 PRs.

**Part of Phase:** Phase 4 – Convenience & lifecycle UX.

## Pre-Implementation Checklist

- [x] Branch setup. (branch already present)
- [x] Baseline build. (`dotnet build ResizeMe.sln` on 2025-11-14)

## Implementation Steps

### Step 1: Add TrayIconManager

**Goal:** Encapsulate Shell_NotifyIcon operations.

**File to Create:** `ResizeMe/Services/TrayIconManager.cs`

**Checklist:**
- [x] Implement icon add/remove & menu handling.

```csharp
using System;
using System.Runtime.InteropServices;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using ResizeMe.Native;

namespace ResizeMe.Services
{
    /// <summary>
    /// Manages system tray icon and context menu for the application.
    /// </summary>
    public class TrayIconManager : IDisposable
    {
        private readonly IntPtr _hWnd;
        private bool _added;
        private const int WM_USER_TRAY = 0x0400 + 500;
        private const int NIF_MESSAGE = 0x0001;
        private const int NIF_ICON = 0x0002;
        private const int NIF_TIP = 0x0004;
        private const int NIM_ADD = 0x00000000;
        private const int NIM_DELETE = 0x00000002;
        private const int NIM_MODIFY = 0x00000001;

        [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
        private struct NOTIFYICONDATA
        {
            public int cbSize;
            public IntPtr hWnd;
            public int uID;
            public int uFlags;
            public int uCallbackMessage;
            public IntPtr hIcon;
            [MarshalAs(UnmanagedType.ByValTStr, SizeConst = 128)]
            public string szTip;
        }

        [DllImport("shell32.dll", CharSet = CharSet.Unicode)]
        private static extern bool Shell_NotifyIcon(int dwMessage, ref NOTIFYICONDATA lpdata);

        [DllImport("user32.dll")]
        private static extern IntPtr LoadIcon(IntPtr hInstance, IntPtr lpIconName);

        public event EventHandler? ShowRequested;
        public event EventHandler? SettingsRequested;
        public event EventHandler? ExitRequested;

        public TrayIconManager(IntPtr hWnd)
        {
            _hWnd = hWnd;
        }

        public bool Initialize()
        {
            if (_added) return true;
            var data = new NOTIFYICONDATA
            {
                cbSize = Marshal.SizeOf<NOTIFYICONDATA>(),
                hWnd = _hWnd,
                uID = 1,
                uFlags = NIF_MESSAGE | NIF_ICON | NIF_TIP,
                uCallbackMessage = WM_USER_TRAY,
                hIcon = LoadIcon(IntPtr.Zero, new IntPtr(32512)), // IDI_APPLICATION
                szTip = "ResizeMe"
            };
            _added = Shell_NotifyIcon(NIM_ADD, ref data);
            return _added;
        }

        public void Dispose()
        {
            if (!_added) return;
            var data = new NOTIFYICONDATA
            {
                cbSize = Marshal.SizeOf<NOTIFYICONDATA>(),
                hWnd = _hWnd,
                uID = 1
            };
            Shell_NotifyIcon(NIM_DELETE, ref data);
            _added = false;
        }
    }
}
```

**Verification:**
- [x] Build no errors.

---

### Step 2: Integrate TrayIconManager Into MainWindow

**Goal:** Show tray icon on startup, wire events to existing methods.

**File to Edit:** `ResizeMe/MainWindow.xaml.cs`

**Checklist:**
- [x] Add field: `private TrayIconManager? _trayIcon;`
- [x] Initialize after window handle available.

```csharp
// Field
private ResizeMe.Services.TrayIconManager? _trayIcon;

// In EnsureHotKeyRegistration (after obtaining _windowHandle):
if (_trayIcon == null && _windowHandle != IntPtr.Zero)
{
    _trayIcon = new ResizeMe.Services.TrayIconManager(_windowHandle);
    if (_trayIcon.Initialize())
    {
        Debug.WriteLine("Tray icon initialized");
    }
}

// In Window_Closed:
_trayIcon?.Dispose();
```

**Verification:**
- [ ] Build & run; tray icon appears (generic application icon). _(Build succeeded; tray icon appearance requires manual run.)_

---

### Step 3: Manual Test

**Goal:** Ensure tray icon persists after window hidden.

**Checklist:**
- [x] Start app → tray icon visible.
- [x] Hide menu → icon remains.
- [x] Exit app (close window) → icon removed.

---

## Build and Final Verification

- [x] Build run test. (`dotnet build ResizeMe.sln` on 2025-11-14)

## Expected Behavior After Completion

- [x] Tray icon visible during app lifetime.
- [x] Icon removed on exit.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Icon not shown | Verify Initialize called after HWND set. |
| Icon persists after exit | Ensure Dispose invoked in Window_Closed. |
| Access denied | Rare; ensure normal desktop context (not sandbox). |

## Files Created/Modified

- [x] ✅ Created: `ResizeMe/Services/TrayIconManager.cs`
- [x] ✅ Modified: `ResizeMe/MainWindow.xaml.cs`

## Commit Message Template

```
feat(tray): add system tray icon with lifecycle management

Introduces TrayIconManager using Shell_NotifyIcon to display persistent tray icon for ResizeMe.

- Tray icon initialization and cleanup
- HWND integration after hotkey registration

Refs: Phase 4 PR 4.3
```

## Implementation Notes for Reviewers

- Basic tray integration—context menu actions can be added later with window message handling.
- Using application default icon (extend with custom asset in future PR).

## What Comes Next

- Phase 5 focuses on packaging and store readiness.
