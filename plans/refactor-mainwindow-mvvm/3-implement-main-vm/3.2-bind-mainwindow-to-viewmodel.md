# Step 3.2: Bind MainWindow to MainViewModel

**Part of:** Step 3 from plan.md  
**Focus:** Update XAML and code-behind to consume `MainViewModel`, removing redundant state fields  
**Files to Edit:** `ResizeMe/MainWindow.xaml`, `ResizeMe/MainWindow.xaml.cs`  
**Estimated Time:** 25 minutes

## Overview

Hook the UI to the new ViewModel so preset rendering, visibility, and status text come from bindable properties rather than private fields. This finishes the MVVM refactor.

## Pre-Substep Checklist

- [ ] **Branch:** `refactor/mainwindow-mvvm`
- [ ] **Current Step:** Step 3.1 complete (ViewModel exists)
- [ ] **Codebase State:** `dotnet build ResizeMe.sln`

## Implementation

### Goal
Instantiate `MainViewModel`, assign it as `DataContext`, migrate state updates, and replace imperative UI updates with bindings.

### Step-by-Step Instructions

#### Step 1: Update XAML bindings
- [x] Open `ResizeMe/MainWindow.xaml`
- [x] Inside root `<Window>`, add namespace: `xmlns:vm="using:ResizeMe.ViewModels"`
- [x] Set `x:DataType="vm:MainViewModel"` on the root `<Grid>` to enable compiled bindings (Used `ViewModel` property instead)
- [x] Bind controls:
  - `ToggleSwitch x:Name="CenterOnResizeToggle"` → `IsOn="{x:Bind ViewModel.CenterOnResize, Mode=TwoWay}"`
  - Status TextBlock → `Text="{x:Bind ViewModel.Status, Mode=OneWay}"`
  - ItemsControl (or StackPanel) hosting presets should bind to `Presets` rather than dynamic creation (if still using manual rendering, leave for now but plan follow-up). For this refactor, keep `DynamicPresetsPanel` but ensure ViewModel feeds data when `RenderPresetButtons` runs.

#### Step 2: Instantiate ViewModel in code-behind
- [x] Add `using ResizeMe.ViewModels;`
- [x] Add field: `private readonly MainViewModel _viewModel;`
- [x] In constructor, assign:

```csharp
_viewModel = new MainViewModel(DispatcherQueue, _presets, _windowDiscovery, _windowResizer);
DataContext = _viewModel;
```

- [x] Await initialization inside `OnRootLoaded`:

```csharp
await _viewModel.InitializeAsync();
```

#### Step 3: Remove duplicated state
- [x] Delete `_state`, `_windows`, `_selectedWindow`, `_status`, `_initialized` if their responsibilities moved into `_viewModel`
- [x] Update methods:
  - Replace `_state.Show()` with `_viewModel.Show();`
  - Replace `_state.Hide()` with `_viewModel.Hide();`
  - Use `_viewModel.CenterOnResize` instead of `UserSettingsStore` toggles directly
  - Use `_viewModel.RefreshWindowSnapshot()` instead of local `_windowDiscovery` queries

#### Step 4: Bind status banner
- [x] Modify `StatusBanner` usage so it just mirrors `_viewModel.Status` (or keep `StatusBanner.Show` but set `_viewModel.Status = message` simultaneously)
- [x] Ensure `StatusText` TextBlock binding matches property updates

#### Step 5: Hook preset clicks to VM
- [x] When creating preset buttons, set `button.DataContext = preset;`
- [x] Update `PresetButton_Click` to call `_ = _viewModel.ResizeSelectedWindowAsync(preset);`
- [x] Let `_viewModel` hide window by toggling `IsVisible` => listen for property changed to call `HideWindow()` when false

Example snippet:

```csharp
_viewModel.PropertyChanged += (_, args) =>
{
    if (args.PropertyName == nameof(MainViewModel.IsVisible))
    {
        if (_viewModel.IsVisible)
        {
            _ = ShowWindowAsync();
        }
        else
        {
            HideWindow();
        }
    }
};
```

#### Step 6: Cleanup
- [x] Remove direct `UserSettingsStore.CenterOnResize` assignments; rely on binding
- [x] Ensure `ToggleVisibility` simply flips `_viewModel.IsVisible`

## Verification Checklist

- [x] Build succeeds
- [ ] Launch app: presets load, status text updates via binding
- [ ] Toggle switch reflects stored setting automatically
- [ ] Hotkey/tray show/hide still works (ViewModel receives calls)

## Troubleshooting

| Issue | Solution |
|-------|----------|
| `x:Bind` errors | Confirm `MainWindow.xaml` includes `x:Class="ResizeMe.MainWindow"` and `x:DataType` uses `vm:MainViewModel`. |
| UI not updating | Ensure `MainViewModel` raises `PropertyChanged` (via `SetProperty`). |
| DataContext null | Set `DataContext = _viewModel;` before `InitializeComponent()` completes (constructor). |

## Files Modified

- [x] ✅ Updated: `ResizeMe/MainWindow.xaml`
- [x] ✅ Updated: `ResizeMe/MainWindow.xaml.cs`
- [x] ✅ Updated: `ResizeMe/Features/MainLayout/PresetButtonFactory.cs`

## What Comes Next

- With Step 3 completed, run a full regression (manual) to ensure hotkeys, tray icon, preset interactions, and settings windows behave identically to pre-refactor behavior.
