# PR 1.2: Settings Window Modernization

**Branch Name:** `feature/modern-settings-ui`

**Description:** Redesigns the `SettingsWindow` with modern Fluent cards, improved form layout, accessible validation feedback, and constrained scrollable width (MaxWidth 680).

**Technology Stack:** WinUI 3 (Windows App SDK 1.8), .NET 8, XAML, C#

**Dependencies:** PR 1.1 (shared styles & tokens defined in `App.xaml`)

**Part of Phase:** Phase 1 – Modern UI Refresh (completes unified visual update)

## Pre-Implementation Checklist

- [ ] **Branch Creation:** If not already on the main/default branch, run:
  ```bash
  cd x:/burkeholland/ResizeMe
  git checkout main
  git pull
  git checkout -b feature/modern-settings-ui
  ```

- [ ] **Verify Project Setup:** Ensure the project builds before changes
  ```bash
  dotnet build ResizeMe.sln
  ```
  Expected output: `Build succeeded.` No XAML or C# errors.

## Implementation Steps

### Step 1: Replace Settings Window Layout (`SettingsWindow.xaml`)

**Goal:** Provide balanced two-column layout (Current Presets | Add New Preset) with card styling, scroll support, and constrained width.

**File to Edit:** `ResizeMe/SettingsWindow.xaml`

**Checklist:**
- [ ] Apply Mica backdrop (`Base`)
- [ ] Constrain width (MinWidth 520, MaxWidth 680) and initial size 640x600
- [ ] Split into header, scroll region, footer action card
- [ ] Use cards for presets list and add form
- [ ] Validation/status text styled and accessible
- [ ] Copy and paste entire content below:

```xml
<Window
  x:Class="ResizeMe.SettingsWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  Title="ResizeMe Settings"
  Width="640"
  MinWidth="520"
  MaxWidth="680"
  Height="600"
  MinHeight="480">
  <Window.SystemBackdrop>
    <MicaBackdrop Kind="Base" />
  </Window.SystemBackdrop>
  <Grid Background="{ThemeResource LayerFillColorDefaultBrush}" Padding="20">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- Header Card -->
    <Border Grid.Row="0"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            CornerRadius="8"
            BorderThickness="1"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            Margin="0,0,0,16"
            Padding="20,16">
      <StackPanel Orientation="Horizontal" Spacing="12">
        <FontIcon FontFamily="Segoe Fluent Icons"
                 Glyph="&#xE8B9;"
                 FontSize="24"
                 Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                 VerticalAlignment="Center" />
        <TextBlock Text="Preset Settings"
                  FontSize="20"
                  FontWeight="SemiBold"
                  VerticalAlignment="Center"
                  Foreground="{ThemeResource TextFillColorPrimaryBrush}" />
      </StackPanel>
    </Border>

    <!-- Content Scroll Region -->
    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
      <Grid ColumnSpacing="20">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Current Presets Card -->
        <Border Grid.Column="0"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8"
                BorderThickness="1"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                Padding="16">
          <StackPanel Spacing="12">
            <TextBlock Text="Current Presets"
                      FontWeight="SemiBold"
                      FontSize="16"
                      Foreground="{ThemeResource TextFillColorPrimaryBrush}" />

            <ListView x:Name="PresetList"
                     SelectionMode="Single"
                     MinHeight="300"
                     MaxHeight="400"
                     Background="{ThemeResource ControlFillColorSecondaryBrush}"
                     CornerRadius="6"
                     Padding="8">
              <ListView.ItemTemplate>
                <DataTemplate>
                  <Border Background="{ThemeResource ControlFillColorDefaultBrush}"
                         CornerRadius="4"
                         Padding="8,6"
                         Margin="0,1">
                    <Grid>
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                      </Grid.ColumnDefinitions>
                      <FontIcon Grid.Column="0"
                               FontFamily="Segoe Fluent Icons"
                               Glyph="&#xE7C4;"
                               FontSize="14"
                               Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0" />
                      <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Name}"
                                  FontWeight="SemiBold"
                                  FontSize="13"
                                  Foreground="{ThemeResource TextFillColorPrimaryBrush}" />
                        <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="11">
                          <Run Text="{Binding Width}" />
                          <Run Text=" x " />
                          <Run Text="{Binding Height}" />
                        </TextBlock>
                      </StackPanel>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>

            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left">
              <Button x:Name="RemoveButton"
                     Content="Remove"
                     Click="RemoveButton_Click"
                     Padding="10,6"
                     FontSize="12"
                     CornerRadius="4" />
              <Button x:Name="ResetButton"
                     Content="Reset"
                     Click="ResetButton_Click"
                     Padding="10,6"
                     FontSize="12"
                     CornerRadius="4" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Add New Preset Card -->
        <Border Grid.Column="1"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8"
                BorderThickness="1"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                Padding="16">
          <StackPanel Spacing="16" VerticalAlignment="Top">
            <TextBlock Text="Add New Preset"
                      FontWeight="SemiBold"
                      FontSize="16"
                      Foreground="{ThemeResource TextFillColorPrimaryBrush}" />

            <StackPanel Spacing="12">
              <TextBox x:Name="NameInput"
                      PlaceholderText="Preset name"
                      FontSize="14"
                      Padding="10"
                      CornerRadius="6" />

              <StackPanel Spacing="8">
                <TextBox x:Name="WidthInput"
                        PlaceholderText="Width (e.g. 1920)"
                        InputScope="Number"
                        FontSize="14"
                        Padding="10"
                        CornerRadius="6" />
                <TextBox x:Name="HeightInput"
                        PlaceholderText="Height (e.g. 1080)"
                        InputScope="Number"
                        FontSize="14"
                        Padding="10"
                        CornerRadius="6" />
              </StackPanel>

              <Button x:Name="AddButton"
                     Content="Add Preset"
                     Style="{StaticResource PrimaryActionButtonStyle}"
                     Click="AddButton_Click"
                     Padding="16,10"
                     CornerRadius="6"
                     HorizontalAlignment="Stretch"
                     FontSize="14" />

              <TextBlock x:Name="ValidationText"
                        Foreground="{ThemeResource SystemFillColorCautionBrush}"
                        FontSize="11"
                        TextWrapping="Wrap"
                        Visibility="Collapsed" />
              <TextBlock x:Name="StatusText"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        FontSize="11"
                        TextWrapping="Wrap" />
            </StackPanel>
          </StackPanel>
        </Border>
      </Grid>
    </ScrollViewer>

    <!-- Footer Card -->
    <Border Grid.Row="2"
            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
            CornerRadius="8"
            BorderThickness="1"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            Padding="20,16"
            Margin="0,16,0,0">
      <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
        <Button x:Name="CloseButton"
               Content="Done"
               Click="CloseButton_Click"
               Style="{StaticResource PrimaryActionButtonStyle}"
               Padding="20,12"
               CornerRadius="6" />
      </StackPanel>
    </Border>
  </Grid>
</Window>
```

**Verification:**
- [ ] Build succeeds; no XAML parse errors.
- [ ] Window displays two columns; vertical scrollbar appears when presets exceed available height.
- [ ] Buttons styled and clickable.

---

### Step 2: Ensure Code-Behind Matches Layout (`SettingsWindow.xaml.cs`)

**Goal:** Provide robust validation, refresh logic, event raising for preset changes, and initial sizing with defensive error handling.

**File to Edit:** `ResizeMe/SettingsWindow.xaml.cs`

**Checklist:**
- [ ] Preserve existing logic; enhance validation visibility toggling.
- [ ] Keep preset CRUD operations intact.
- [ ] Maintain `PresetsChanged` event.
- [ ] Copy and paste entire content below:

```csharp
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Input;
using ResizeMe.Models;
using ResizeMe.Services;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System;

namespace ResizeMe
{
    /// <summary>
    /// Settings window for managing resize presets.
    /// </summary>
    public sealed partial class SettingsWindow : Window
    {
        /// <summary>Raised after XAML root loads.</summary>
        public event RoutedEventHandler? Loaded;

        private readonly PresetManager _manager = new();
        private readonly ObservableCollection<PresetSize> _view = new();

        /// <summary>Raised when presets are added, removed, or reset.</summary>
        public event EventHandler? PresetsChanged;

        public SettingsWindow()
        {
            InitializeComponent();
            Title = "ResizeMe Settings";
            PresetList.ItemsSource = _view;
            Loaded += OnLoaded;
            WidthInput.KeyUp += OnDimensionKeyUp;
            HeightInput.KeyUp += OnDimensionKeyUp;
            DispatcherQueue.TryEnqueue(() => Loaded?.Invoke(this, new RoutedEventArgs()));
        }

        private async void OnLoaded(object sender, RoutedEventArgs e)
        {
            await _manager.LoadAsync();
            RefreshView();
            SetWindowSize();
        }

        /// <summary>Attempts to set initial window size safely.</summary>
        private void SetWindowSize()
        {
            try
            {
                var hWnd = WinRT.Interop.WindowNative.GetWindowHandle(this);
                if (hWnd == IntPtr.Zero) return;
                var windowId = Microsoft.UI.Win32Interop.GetWindowIdFromWindow(hWnd);
                var appWindow = Microsoft.UI.Windowing.AppWindow.GetFromWindowId(windowId);
                appWindow?.Resize(new Windows.Graphics.SizeInt32(640, 600));
            }
            catch (ArgumentException)
            {
                // Non-fatal: continue if sizing fails.
            }
        }

        /// <summary>Refreshes the observable view from the manager.</summary>
        private void RefreshView()
        {
            _view.Clear();
            foreach (var p in _manager.Presets.OrderBy(p => p.Name)) _view.Add(p);
            StatusText.Text = $"Loaded {_view.Count} presets";
        }

        /// <summary>Adds a new preset after validation.</summary>
        private async void AddButton_Click(object sender, RoutedEventArgs e)
        {
            HideValidation();
            string name = NameInput.Text.Trim();
            if (!int.TryParse(WidthInput.Text, out int width) || !int.TryParse(HeightInput.Text, out int height))
            {
                ShowValidation("Width and Height must be valid numbers");
                return;
            }
            if (width <= 0 || height <= 0)
            {
                ShowValidation("Dimensions must be greater than 0");
                return;
            }
            if (string.IsNullOrWhiteSpace(name)) name = $"{width}x{height}";
            var preset = new PresetSize { Name = name, Width = width, Height = height };
            bool added = await _manager.AddPresetAsync(preset);
            if (!added)
            {
                ShowValidation("A preset with this name already exists");
                return;
            }
            RefreshView();
            NotifyPresetsChanged();
            StatusText.Text = $"Successfully added '{preset.Name}' preset";
            NameInput.Text = WidthInput.Text = HeightInput.Text = string.Empty;
            NameInput.Focus(FocusState.Programmatic);
        }

        /// <summary>Removes selected preset if one is chosen.</summary>
        private async void RemoveButton_Click(object sender, RoutedEventArgs e)
        {
            HideValidation();
            if (PresetList.SelectedItem is PresetSize ps)
            {
                bool removed = await _manager.RemovePresetAsync(ps.Name);
                StatusText.Text = removed ? $"Removed {ps.Name}" : "Remove failed";
                if (removed)
                {
                    RefreshView();
                    NotifyPresetsChanged();
                }
            }
            else ShowValidation("Select preset first");
        }

        /// <summary>Resets presets to default seeds.</summary>
        private async void ResetButton_Click(object sender, RoutedEventArgs e)
        {
            HideValidation();
            await _manager.ResetToDefaultsAsync();
            RefreshView();
            NotifyPresetsChanged();
            StatusText.Text = "Defaults restored";
        }

        /// <summary>Handles Enter key to submit dimensions quickly.</summary>
        private void OnDimensionKeyUp(object sender, KeyRoutedEventArgs e)
        {
            if (e.Key == Windows.System.VirtualKey.Enter) AddButton_Click(sender, e);
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e) => Close();

        /// <summary>Raises PresetsChanged event.</summary>
        private void NotifyPresetsChanged() => PresetsChanged?.Invoke(this, EventArgs.Empty);

        private void ShowValidation(string message)
        {
            ValidationText.Text = message;
            ValidationText.Visibility = Visibility.Visible;
        }

        private void HideValidation()
        {
            ValidationText.Text = string.Empty;
            ValidationText.Visibility = Visibility.Collapsed;
        }
    }
}
```

**Verification:**
- [ ] Build compiles with no errors.
- [ ] Adding valid preset updates list and status; duplicates show validation text.
- [ ] Reset repopulates defaults; status reflects change.

---

### Step 3: Runtime Validation & Accessibility

**Goal:** Confirm scroll behavior, keyboard navigation, and high contrast readability.

**File to Edit:** (None – runtime checks)

**Checklist:**
- [ ] Tab through inputs (Name → Width → Height → Add Button) – logical order.
- [ ] Press Enter inside Width/Height → preset added.
- [ ] Resize window vertically → scroll activates when list taller than view.
- [ ] Switch OS theme (dark/light) – foregrounds maintain contrast.

**Verification:**
- [ ] Validation message appears only on error and hides after successful add.
- [ ] High contrast test (Windows accessibility settings) yields readable button text.

---

## Build and Final Verification

**Checklist:**
- [ ] **Build/Test the project:**
  ```bash
  dotnet build ResizeMe.sln
  ```
  Expected: `Build succeeded.` No warnings referencing `SettingsWindow.xaml` or code-behind.

- [ ] **Check for errors:**
  - [ ] If XAML parse issue: confirm closing tags & `Window.SystemBackdrop` present.
  - [ ] If validation text never shows: ensure `Visibility="Collapsed"` default and `ShowValidation` sets `Visible`.
  - [ ] If presets not refreshing: verify `_view` is bound via `PresetList.ItemsSource = _view;`.

- [ ] **Optional: Manual Testing**
  - [ ] Launch app, open settings via floating window.
  - [ ] Add new preset (e.g., 2500x1400) – appears sorted by name.
  - [ ] Remove selected preset – it disappears.
  - [ ] Reset – defaults restored.

## Expected Behavior After Completion

- [ ] Settings window shows polished two-column layout with cards.
- [ ] Preset list scrolls when long; add form remains visible.
- [ ] Validation feedback displays caution color for invalid input.
- [ ] PresetsChanged event fires after add/remove/reset enabling UI refresh externally.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| XAML parse error on launch | Ensure entire XML copied; check for stray BOM or missing `xmlns` declarations. |
| Validation never visible | Confirm `ShowValidation` sets `Visibility.Visible` and not overwritten later; check event wiring for buttons. |
| Duplicates allowed | Verify `PresetManager.AddPresetAsync` uniqueness logic; ensure name normalization (trim). |
| Scrollbar absent with many presets | Check `MaxHeight="400"` on `ListView`; ensure enough items to exceed height. |
| Presets not sorted | Confirm `RefreshView()` orders by `p.Name` before adding to `_view`. |

## Files Created/Modified

- [ ] ✅ Modified: `ResizeMe/SettingsWindow.xaml`
- [ ] ✅ Modified: `ResizeMe/SettingsWindow.xaml.cs`
- [ ] ✅ No changes: `Services/*`, `Models/*`, `MainWindow.*`

## Commit Message Template

```
feat(ui): modernize settings window layout

Redesigns settings window with Fluent cards, two-column scrollable layout, accessible validation messaging, and constrained width.

- Adds card layout + form enhancements
- Improves validation visibility logic
- Maintains preset CRUD & event dispatch
```

## Implementation Notes for Reviewers
- Only presentation layer altered; preset persistence untouched.
- Width constraints chosen to avoid horizontal crowding while limiting excessive stretch.
- Validation logic centralized via helper methods for clarity & reuse.

## What Comes Next
- Unified styling complete; potential future PR could migrate settings to in-window page navigation.
- Enables further enhancements (search/filter presets, categories) without structural overhaul.
- Consider adding unit tests for `PresetManager` to cover edge cases (already stable but untested here).
