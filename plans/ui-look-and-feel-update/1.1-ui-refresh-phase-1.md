# PR 1.1: Unified UI Refresh

**Branch Name:** `ui-refresh-phase-1`

**Description:** Redesigns floating preset menu and Settings window layout/styles to eliminate truncation, avoid title bar overlap, and improve professional Fluent appearance.

**Technology Stack:** WinUI 3 (Windows App SDK 1.8), .NET 8, XAML, C#

**Dependencies:** None (first and only phase)

**Part of Phase:** Phase 1 – UI Look & Feel Update (master plan single-phase execution)

## Pre-Implementation Checklist

- [ ] **Branch Creation:**
  ```bash
  cd x:/burkeholland/ResizeMe
  git checkout main
  git pull
  git checkout -b ui-refresh-phase-1
  ```

- [ ] **Verify Project Setup:** Build solution to ensure clean baseline
  ```bash
  dotnet build ResizeMe.sln
  ```
  Expected output: Build succeeds (0 errors), WinExe project `ResizeMe` compiles targeting `net8.0-windows10.0.19041.0` with Windows App SDK references restored.

## Implementation Steps

### Step 1: Update Shared Styles for Buttons & Text

**Goal:** Introduce refined spacing, action button style, and preset typography improvements for consistency and readability.

**File to Edit:** `ResizeMe/App.xaml`

**Checklist:**
- [ ] Add new styles: `PrimaryActionButtonStyle`, refined preset styles, spacing tokens.
- [ ] Keep existing resources intact; append new dictionary entries.
- [ ] Copy and paste entire updated file content below.

```xml
<?xml version="1.0" encoding="utf-8"?>
<Application
    x:Class="ResizeMe.App"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:ResizeMe"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <XamlControlsResources xmlns="using:Microsoft.UI.Xaml.Controls" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Spacing tokens -->
            <x:Double x:Key="SpacingXS">4</x:Double>
            <x:Double x:Key="SpacingSM">8</x:Double>
            <x:Double x:Key="SpacingMD">12</x:Double>
            <x:Double x:Key="SpacingLG">16</x:Double>

            <!-- Base style for preset buttons -->
            <Style x:Key="PresetButtonBaseStyle" TargetType="Button" BasedOn="{StaticResource DefaultButtonStyle}">
                <Setter Property="Height" Value="52"/>
                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                <Setter Property="Padding" Value="12,8"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="Background" Value="{ThemeResource ControlFillColorDefaultBrush}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource ControlStrokeColorDefaultBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="ToolTipService.ToolTip" Value="Resize to preset dimensions"/>
            </Style>

            <!-- Active (selected) preset style -->
            <Style x:Key="ActivePresetButtonStyle" TargetType="Button" BasedOn="{StaticResource PresetButtonBaseStyle}">
                <Setter Property="Background" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
                <Setter Property="Foreground" Value="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource AccentStrokeColorDefaultBrush}"/>
            </Style>

            <!-- Preset header text -->
            <Style x:Key="PresetHeaderTextStyle" TargetType="TextBlock" BasedOn="{StaticResource BodyStrongTextBlockStyle}">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextWrapping" Value="Wrap"/>
            </Style>

            <!-- Preset sub text -->
            <Style x:Key="PresetSubTextStyle" TargetType="TextBlock" BasedOn="{StaticResource CaptionTextBlockStyle}">
                <Setter Property="Opacity" Value="0.78"/>
            </Style>

            <!-- Primary action button (Settings, Add, etc.) -->
            <Style x:Key="PrimaryActionButtonStyle" TargetType="Button" BasedOn="{StaticResource DefaultButtonStyle}">
                <Setter Property="Padding" Value="14,8"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="Background" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
                <Setter Property="Foreground" Value="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource AccentStrokeColorDefaultBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
            </Style>

            <!-- Subtle toolbar button -->
            <Style x:Key="ToolbarIconButtonStyle" TargetType="Button" BasedOn="{StaticResource SubtleButtonStyle}">
                <Setter Property="Width" Value="32"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Padding" Value="4"/>
                <Setter Property="CornerRadius" Value="4"/>
            </Style>
        </ResourceDictionary>
    </Application.Resources>
</Application>
```

**Verification:**
- [ ] Build solution: no XAML parse errors.
- [ ] Styles appear in IntelliSense for `MainWindow.xaml` & `SettingsWindow.xaml`.
- [ ] No duplicate keys causing runtime exceptions.

---

### Step 2: Refine Floating Preset Menu Layout

**Goal:** Prevent title bar overlap with system caption buttons and ensure preset text is fully visible by enlarging width and adjusting margins.

**File to Edit:** `ResizeMe/MainWindow.xaml`

**Checklist:**
- [ ] Reserve right-side space for system buttons (margin/padding).
- [ ] Increase base window content width and adjust scroll margins.
- [ ] Apply new styles and wrapping behavior.
- [ ] Copy and paste entire updated file content below.

```xml
<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="ResizeMe.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:ResizeMe">
    <Window.SystemBackdrop>
        <MicaBackdrop Kind="BaseAlt" />
    </Window.SystemBackdrop>
    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            CornerRadius="8"
            BorderThickness="1"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
        <Grid x:Name="RootGrid" MinWidth="340" MaxWidth="380">
            <Grid.RowDefinitions>
                <RowDefinition Height="48" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Title Bar (leave 72px on right for system caption buttons) -->
            <Grid x:Name="TitleBar" Grid.Row="0" Background="Transparent" Margin="16,8,72,8" HorizontalAlignment="Stretch">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8B9;" FontSize="16" Foreground="{ThemeResource AccentAAFillColorDefaultBrush}" />
                    <TextBlock Text="ResizeMe" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorPrimaryBrush}" />
                    <TextBlock x:Name="StatusText" Text="Ready" FontSize="12" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="12,0,0,0" />
                </StackPanel>
                <Button x:Name="SettingsButton" Grid.Column="1" Style="{StaticResource ToolbarIconButtonStyle}" ToolTipService.ToolTip="Settings" Click="SettingsButton_Click">
                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE713;" FontSize="14" />
                </Button>
            </Grid>

            <!-- Content -->
            <ScrollViewer Grid.Row="1" Margin="16,4,16,12" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                <StackPanel Spacing="16">
                    <StackPanel x:Name="PresetsSection" Spacing="12">
                        <TextBlock Text="Quick Resize" FontWeight="SemiBold" FontSize="16" />
                        <StackPanel x:Name="DynamicPresetsPanel" Orientation="Vertical" Spacing="6" />
                        <TextBlock x:Name="PresetHint" Text="Customize in Settings" FontSize="11" Opacity="0.7" />
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Footer -->
            <Border Grid.Row="2" Background="{ThemeResource ControlFillColorDefaultBrush}" CornerRadius="0,0,8,8" Padding="16,8" >
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Win+Shift+F12 to toggle" FontSize="11" VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
```

**Verification:**
- [ ] Build succeeds.
- [ ] When running, Settings button no longer sits under system Close.
- [ ] Window minimum width increased; preset names wrap when long.

---

### Step 3: Adjust MainWindow Sizing Logic

**Goal:** Ensure runtime window size matches new design width and avoids preset truncation.

**File to Edit:** `ResizeMe/MainWindow.xaml.cs`

**Checklist:**
- [ ] Modify `SetupWindowAppearance` to use width 360 × 360 height (slight expansion) and ensure min width is respected.
- [ ] Add inline comment explaining reserved caption button space.
- [ ] Copy updated file excerpt (full file for clarity) below.

```csharp
using Microsoft.UI.Windowing;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Input;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Windows.Graphics;

namespace ResizeMe
{
    /// <summary>
    /// Floating context menu window providing preset resize buttons with toggle behavior.
    /// </summary>
    public sealed partial class MainWindow : Window
    {
        public event RoutedEventHandler? Loaded;
        private HotKeyManager? _hotKeyManager;
        private WindowManager? _windowManager;
        private WindowResizer? _windowResizer;
        private readonly PresetManager _presetManager = new();
        private IntPtr _windowHandle = IntPtr.Zero;
        private AppWindow? _appWindow;
        private bool _isSubclassRegistered;
        private bool _isVisible;
        private bool _isAlwaysOnTop;
        private WindowInfo? _selectedWindow;
        private List<WindowInfo> _availableWindows = new();
        private string? _activePresetTag;
        private int _presetIndex = -1;
        private TrayIconManager? _trayIcon;
        private DateTime _lastToggle = DateTime.MinValue;
        private WinApiSubClass.SubClassProc? _subclassProc;
        private readonly IntPtr _subClassId = new(1001);

        public MainWindow()
        {
            InitializeComponent();
            _windowManager = new WindowManager();
            _windowResizer = new WindowResizer();
            AttachWindowLoadedHandler();
            Loaded += async (_, _) => { await _presetManager.LoadAsync(); LoadPresetButtons(); };
            SetupWindowAppearance();
            AttachKeyDownHandler();
            Activated += OnWindowActivated;
            Closed += Window_Closed;
        }

        private void AttachWindowLoadedHandler()
        {
            if (Content is FrameworkElement root)
            {
                root.Loaded += Root_Loaded;
            }
            else
            {
                DispatcherQueue.TryEnqueue(async () =>
                {
                    await _presetManager.LoadAsync();
                    LoadPresetButtons();
                });
            }
        }

        private void Root_Loaded(object sender, RoutedEventArgs e)
        {
            if (Content is FrameworkElement root)
            {
                root.Loaded -= Root_Loaded;
            }
            Loaded?.Invoke(this, e);
        }

        private void AttachKeyDownHandler()
        {
            if (Content is FrameworkElement element)
            {
                element.KeyDown -= OnKeyDown;
                element.KeyDown += OnKeyDown;
            }
        }

        private void SetupWindowAppearance()
        {
            try
            {
                Title = "ResizeMe";
                ExtendsContentIntoTitleBar = true;
                SetTitleBar(TitleBar); // TitleBar element leaves right margin for system caption buttons.
                EnsureWindowHandle();
                if (_windowHandle != IntPtr.Zero)
                {
                    var windowId = Win32Interop.GetWindowIdFromWindow(_windowHandle);
                    _appWindow = AppWindow.GetFromWindowId(windowId);
                    // Slight width increase (was 300) to prevent preset text truncation; reserved right margin handled in XAML.
                    _appWindow?.Resize(new SizeInt32(360, 360));
                    WindowsApi.ShowWindow(_windowHandle, WindowsApi.SW_HIDE);
                }
                _isVisible = false;
                StatusText.Text = "Ready";
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"SetupWindowAppearance error: {ex.Message}");
            }
        }

        private void EnsureWindowHandle()
        {
            if (_windowHandle != IntPtr.Zero) return;
            _windowHandle = WindowNative.GetWindowHandle(this);
            if (_windowHandle != IntPtr.Zero && _appWindow == null)
            {
                var windowId = Win32Interop.GetWindowIdFromWindow(_windowHandle);
                _appWindow = AppWindow.GetFromWindowId(windowId);
            }
        }

        // Remaining members unchanged...
        // (For brevity, other methods remain identical to existing implementation.)
    }

    internal static class WinApiSubClass { /* existing code ... */ }
    internal static class AnimationExtensions { /* existing code ... */ }
}
```

**Verification:**
- [ ] Build succeeds.
- [ ] Run app: floating menu initial size ~360×360.
- [ ] Preset names fully visible at default scale.

---

### Step 4: Redesign Settings Window Layout

**Goal:** Provide balanced professional layout with constrained width, scroll support, and consistent spacing/styles.

**File to Edit:** `ResizeMe/SettingsWindow.xaml`

**Checklist:**
- [ ] Constrain width (MaxWidth 680, MinWidth 520) and height with scroll area.
- [ ] Apply action styles and improved grouping.
- [ ] Add section separators for clarity.
- [ ] Copy and paste entire updated file content below.

```xml
<Window
  x:Class="ResizeMe.SettingsWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  Title="ResizeMe Settings"
  Width="640"
  MinWidth="520"
  MaxWidth="680"
  Height="600"
  MinHeight="480">
  <Window.SystemBackdrop>
    <MicaBackdrop Kind="Base" />
  </Window.SystemBackdrop>
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- Header -->
    <StackPanel Orientation="Horizontal" Padding="20,16,20,8" Spacing="12">
      <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8B9;" FontSize="20" Foreground="{ThemeResource AccentAAFillColorDefaultBrush}" />
      <TextBlock Text="Preset Sizes" FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center" />
    </StackPanel>

    <!-- Content Scroll Region -->
    <ScrollViewer Grid.Row="1" Padding="20,0,20,0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
      <Grid RowSpacing="24">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Existing Presets -->
        <StackPanel Grid.Row="0" Spacing="12">
          <TextBlock Text="Current Presets" FontWeight="SemiBold" FontSize="16" />
          <Border Background="{ThemeResource ControlFillColorDefaultBrush}" Padding="12" CornerRadius="6" BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}" BorderThickness="1">
            <StackPanel Spacing="12">
              <ListView x:Name="PresetList" SelectionMode="Single" MinHeight="220">
                <ListView.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                      <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                      <TextBlock Text="{Binding Width}" />
                      <TextBlock Text="x" />
                      <TextBlock Text="{Binding Height}" />
                    </StackPanel>
                  </DataTemplate>
                </ListView.ItemTemplate>
              </ListView>
              <StackPanel Orientation="Horizontal" Spacing="8">
                <Button x:Name="RemoveButton" Content="Remove" Click="RemoveButton_Click" />
                <Button x:Name="ResetButton" Content="Reset Defaults" Click="ResetButton_Click" />
              </StackPanel>
            </StackPanel>
          </Border>
        </StackPanel>

        <!-- Add New Preset -->
        <StackPanel Grid.Row="1" Spacing="12">
          <TextBlock Text="Add New Preset" FontWeight="SemiBold" FontSize="16" />
          <Border Background="{ThemeResource ControlFillColorDefaultBrush}" Padding="12" CornerRadius="6" BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}" BorderThickness="1">
            <StackPanel Spacing="10">
              <TextBox x:Name="NameInput" PlaceholderText="Name" />
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBox x:Name="WidthInput" PlaceholderText="Width" Width="120" InputScope="Number" />
                <TextBox x:Name="HeightInput" PlaceholderText="Height" Width="120" InputScope="Number" />
                <Button x:Name="AddButton" Content="Add" Style="{StaticResource PrimaryActionButtonStyle}" Click="AddButton_Click" />
              </StackPanel>
              <TextBlock x:Name="ValidationText" Foreground="{ThemeResource SystemFillColorCautionBrush}" FontSize="12" TextWrapping="Wrap" />
              <TextBlock x:Name="StatusText" Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="12" TextWrapping="Wrap" />
            </StackPanel>
          </Border>
        </StackPanel>
      </Grid>
    </ScrollViewer>

    <!-- Footer Actions -->
    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Padding="20,12,20,16">
      <Button x:Name="CloseButton" Content="Close" Click="CloseButton_Click" />
    </StackPanel>
  </Grid>
</Window>
```

**Verification:**
- [ ] Build succeeds.
- [ ] Settings window width constrained (cannot exceed 680px).
- [ ] Scroll appears if preset list grows tall.
- [ ] Add/Remove actions behave unchanged.

---

### Step 5: Rebuild & Manual UI Validation

**Goal:** Confirm all visual updates integrate without runtime or functional regressions.

**File to Edit:** (No file edit – build & run)

**Checklist:**
- [ ] Build solution.
- [ ] Run app; open floating menu; check preset buttons.
- [ ] Open Settings; validate layout.
- [ ] Test keyboard navigation (Tab through controls, Esc closes floating menu if shown).
- [ ] Resize system text scale (Windows Settings) to 125% and confirm no overlap.

```bash
dotnet build ResizeMe.sln
```

**Verification:**
- [ ] 0 build errors.
- [ ] Visual checks pass at 100% & 125% scale.
- [ ] No caption button overlap; Settings reserved margin holds.

---

## Build and Final Verification

**Checklist:**
- [ ] **Build/Test the project:**
  ```bash
  dotnet build ResizeMe.sln
  ```
  Expected: Build succeeded, no warnings related to XAML parse.

- [ ] **Check for errors:**
  - [ ] If XAML error: ensure file header matches original and all namespaces present.
  - [ ] Confirm new styles not mis-typed (key names consistent across files).
  - [ ] Ensure `SetTitleBar(TitleBar)` still references existing element.

- [ ] **Optional: Manual Testing**
  - [ ] Launch app, trigger hotkey to show menu.
  - [ ] Click each preset – status updates & hides after resize.
  - [ ] Open Settings via toolbar button – window appears with new layout.

## Expected Behavior After Completion

- [ ] Floating menu width prevents preset name truncation.
- [ ] Settings button never overlaps system caption buttons.
- [ ] Settings window displays grouped sections with scroll on overflow.
- [ ] Active preset visually distinct via accent style.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Settings button still under Close | Ensure `Margin="16,8,72,8"` on `TitleBar` and `SetTitleBar(TitleBar)` call present in code-behind. |
| Preset buttons truncate text | Verify `_appWindow?.Resize(new SizeInt32(360, 360));` executed and `MinWidth` >= 340 in XAML; check long names wrap (TextWrapping set). |
| Styles not applied | Confirm `App.xaml` new style keys match usage (`ToolbarIconButtonStyle`, `PrimaryActionButtonStyle`). Rebuild to apply resource changes. |
| XAML parse error on run | Look for missing closing tags or improper XML header; restore original file header if altered. |
| High contrast unreadable buttons | Inspect background/foreground pair; adjust `AccentFillColor` usage or fallback to `ControlFillColorSecondaryBrush`. |

## Files Created/Modified

- [ ] ✅ Modified: `ResizeMe/App.xaml`
- [ ] ✅ Modified: `ResizeMe/MainWindow.xaml`
- [ ] ✅ Modified: `ResizeMe/MainWindow.xaml.cs` (partial update)
- [ ] ✅ Modified: `ResizeMe/SettingsWindow.xaml`
- [ ] ✅ No changes: Service/backend logic files (`PresetManager`, `WindowResizer`, etc.)

## Commit Message Template

```
feat(ui): refresh floating menu and settings window layout

Implements unified UI refresh: widened floating menu, reserved caption space, enhanced preset styles, constrained Settings window with grouped sections and scroll support.

- Adds new style resources and spacing tokens
- Adjusts title bar margins & window sizing logic
- Redesigns Settings layout for professional Fluent look

Refs: UI polish initiative
```

## Implementation Notes for Reviewers

Focused exclusively on presentation layer; no service or resize logic touched. Width increase chosen as minimal viable to prevent truncation at typical scales. Title bar right margin solution avoids complex hit-test handling. Future improvement could adopt adaptive triggers for ultra-narrow scenarios.

## What Comes Next

Once merged:
- Optional follow-up could introduce user theme customization or localization prep.
- Potential enhancement: dynamic preset grouping or search/filter UX.
- Technical debt: Consolidation of style tokens into a dedicated `Theme` resource dictionary.
