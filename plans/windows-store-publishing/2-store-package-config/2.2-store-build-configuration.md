# Step 2.2: Configure Store-Compatible Build Process

**Part of:** Step 2 from plan.md  
**Focus:** Update build configuration for Microsoft Store package requirements  
**File to Edit:** `ResizeMe/ResizeMe.csproj`  
**Estimated Time:** 10-15 minutes

## Overview

This substep configures the project build settings to generate store-compatible MSIX packages with proper signing configuration, versioning strategy, and package optimization.

## Pre-Substep Checklist

- [ ] **Branch:** Working on `feature/windows-store-publishing` (from plan.md)
- [ ] **Current Step:** Completed Step 2.1 - Package manifest updated with store identity
- [ ] **Prerequisites:** Store identity configured in Package.appxmanifest
- [ ] **Codebase State:** Project builds successfully (`dotnet build ResizeMe.sln`)
 - [x] **Branch:** Working on `feature/windows-store-publishing` (from plan.md)
 - [x] **Current Step:** Completed Step 2.1 - Package manifest updated with store identity
 - [x] **Prerequisites:** Store identity configured in Package.appxmanifest
 - [x] **Codebase State:** Project builds successfully (`dotnet build ResizeMe.sln`)

## Implementation

### Goal
Configure ResizeMe.csproj for store-compatible MSIX package generation with proper versioning and build settings.

### Step-by-Step Instructions

#### Step 1: Add Store Package Properties
- [x] Open `ResizeMe/ResizeMe.csproj` in text editor
- [x] Locate the first `<PropertyGroup>` section (around line 2)
- [x] Add store-specific properties after the existing properties:

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows10.0.19041.0</TargetFramework>
    <TargetPlatformMinVersion>10.0.17763.0</TargetPlatformMinVersion>
    <RootNamespace>ResizeMe</RootNamespace>
    <ApplicationManifest>app.manifest</ApplicationManifest>
    <Platforms>x86;x64;ARM64</Platforms>
    <RuntimeIdentifiers>win-x86;win-x64;win-arm64</RuntimeIdentifiers>
    <PublishProfile>win-$(Platform).pubxml</PublishProfile>
    <UseWinUI>true</UseWinUI>
    <EnableMsixTooling>true</EnableMsixTooling>
    <Nullable>enable</Nullable>
    
    <!-- Store Package Configuration -->
    <GenerateAppInstallerFile>false</GenerateAppInstallerFile>
    <AppxAutoIncrementPackageRevision>true</AppxAutoIncrementPackageRevision>
    <AppxSymbolPackageEnabled>false</AppxSymbolPackageEnabled>
    <GenerateTestArtifacts>false</GenerateTestArtifacts>
    <AppxBundle>Never</AppxBundle>
    <AppxPackageSigningEnabled>false</AppxPackageSigningEnabled>
    <PackageCertificateThumbprint />
  </PropertyGroup>
```

#### Step 2: Add Store Build Configuration
- [x] After the first PropertyGroup, add store-specific build configuration:

```xml
  <!-- Store Release Configuration -->
  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <DebugType>none</DebugType>
    <DebugSymbols>false</DebugSymbols>
    <Optimize>true</Optimize>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
  </PropertyGroup>

  <!-- Store Package Validation -->
  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <AppxPackageValidationEnabled>true</AppxPackageValidationEnabled>
    <AppxValidateStore>true</AppxValidateStore>
  </PropertyGroup>
```

#### Step 3: Update Publish Properties for Store
- [x] Locate the existing "Publish Properties" section (around line 54)
- [x] Replace it with store-optimized publish settings:

```xml
  <!-- Store-Compatible Publish Properties -->
  <PropertyGroup>
    <PublishReadyToRun Condition="'$(Configuration)' == 'Debug'">False</PublishReadyToRun>
    <PublishReadyToRun Condition="'$(Configuration)' == 'Release' and '$(RuntimeIdentifier)' != ''">True</PublishReadyToRun>
    <PublishReadyToRun Condition="'$(Configuration)' == 'Release' and '$(RuntimeIdentifier)' == ''">False</PublishReadyToRun>
    <PublishTrimmed Condition="'$(Configuration)' == 'Debug'">False</PublishTrimmed>
    <PublishTrimmed Condition="'$(Configuration)' == 'Release'">False</PublishTrimmed>
    
    <!-- Store Package Optimization -->
    <PublishSingleFile>false</PublishSingleFile>
    <SelfContained>false</SelfContained>
    <RuntimeIdentifier />
  </PropertyGroup>
```

#### Step 4: Add Store Asset Validation
- [x] After the package references, add asset validation:

```xml
  <!-- Store Asset Validation -->
  <ItemGroup Condition="'$(Configuration)' == 'Release'">
    <AppxManifestImageValidation Include="Assets\*.png" />
    <AppxManifestImageValidation Include="Assets\*.jpg" />
  </ItemGroup>
```

#### Step 5: Add Store Publishing Target
- [x] At the end of the file, before the closing `</Project>` tag, add:

```xml
  <!-- Store Package Creation Target -->
  <Target Name="CreateStorePackage" Condition="'$(Configuration)' == 'Release'">
    <Message Text="Building store-compatible MSIX package..." Importance="high" />
    <MSBuild Projects="$(MSBuildProjectFile)"
             Properties="Configuration=Release;Platform=$(Platform);AppxPackageDir=$(OutputPath)AppPackages\;AppxPackageSigningEnabled=false;UapAppxPackageBuildMode=StoreUpload"
             Targets="Build" />
  </Target>
```

## Complete Updated Project File Structure

The final ResizeMe.csproj should have this structure:

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <!-- Existing properties -->
    <!-- Store Package Configuration (added) -->
  </PropertyGroup>

  <!-- Store Release Configuration (added) -->
  
  <!-- Store Package Validation (added) -->

  <ItemGroup>
    <!-- Existing asset content items -->
  </ItemGroup>

  <ItemGroup>
    <!-- Existing manifest -->
  </ItemGroup>

  <ItemGroup Condition="'$(DisableMsixProjectCapabilityAddedByProject)'!='true' and '$(EnableMsixTooling)'=='true'">
    <!-- Existing project capability -->
  </ItemGroup>

  <ItemGroup>
    <!-- Existing package references -->
  </ItemGroup>

  <!-- Store-Compatible Publish Properties (updated) -->

  <!-- Store Asset Validation (added) -->

  <!-- Store Package Creation Target (added) -->
</Project>
```

## Verification Checklist

- [x] File saved with all store configuration properties added
- [x] No build errors: `dotnet build ResizeMe.sln -c Release`
- [x] Store validation enabled for Release configuration
- [x] Package signing disabled (Microsoft Store will sign)
- [x] Asset validation configured for Release builds
- [x] Publish properties optimized for store deployment
 - [x] Store package creation target succeeds: `dotnet build ResizeMe/ResizeMe.csproj -c Release -p:Platform=x64 -t:CreateStorePackage`
 - [x] Verify package output location: `ResizeMe/bin/x64/Release/net8.0-windows10.0.19041.0/win-x64/AppPackages/ResizeMe_1.0.0.0_x64.msixupload`

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Build fails with store validation | Check Package.appxmanifest store identity is correct |
| Asset validation errors | Ensure all referenced logo files exist in Assets folder |
| Package generation fails | Verify EnableMsixTooling=true and all required assets present |
| Publish properties conflict | Remove any conflicting publish settings from existing PropertyGroups |

## Test Store Build Process

Run these commands to validate the configuration:

```powershell
# Test Release build
dotnet build ResizeMe.sln -c Release

# Test store package creation (if target added)
dotnet build ResizeMe/ResizeMe.csproj -c Release -t:CreateStorePackage

# Verify package output location
dir ResizeMe/bin/Release/net8.0-windows10.0.19041.0/win-x64/AppPackages/
```

## Files Modified

- [ ] ✅ **Modified**: `ResizeMe/ResizeMe.csproj`
 - [ ] ✅ **Modified**: `ResizeMe/ResizeMe.csproj`
 - [ ] ✅ **Modified**: `ResizeMe/Package.appxmanifest`

## What Comes Next

- Next substep: Step 2.3 - Store Asset Validation  
- Build configuration is now store-compatible
- Ready for store package generation testing
- Asset validation and build process verification in Step 3

## Important Notes

- **AppxPackageSigningEnabled=false** is correct - Microsoft Store will sign packages
- **Store validation** only runs in Release configuration to avoid development overhead
- **PublishTrimmed=false** recommended for WinUI apps to avoid runtime issues
- **AppxBundle=Never** creates individual architecture packages as preferred by store
- **Asset validation** ensures all manifest-referenced images are present and properly formatted