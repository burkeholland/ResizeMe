# Step 3.1: First Minimize Notification

**Part of:** Step 3 from plan.md  
**Focus:** Show one-time tray/hotkey info message when window first hides to tray.  
**Files to Edit:** `ResizeMe/Services/UserPreferences.cs`, `ResizeMe/MainWindow.xaml.cs`, `ResizeMe/Native/WindowsApi.cs` (MessageBox P/Invoke)  
**Estimated Time:** 12 minutes

## Overview
Adds `FirstMinimizeNotificationShown` preference and logic to display a one-time message box the first time the app is minimized/hidden to tray explaining tray access and current hotkey.

## Pre-Substep Checklist

- [x] **Branch:** `system-tray-integration`
- [ ] **Prior Steps:** Steps 1 & 2 complete
- [x] **Build OK:** `dotnet build ResizeMe.sln`

## Implementation

### Goal
Inform user about tray and hotkey on first hide, then persist suppression flag.

### Step-by-Step Instructions

#### Step 1: Add Preference Property
- [x] Open `ResizeMe/Services/UserPreferences.cs`
- [ ] Under `FirstRunCompleted` add:

```csharp
private const string FirstMinimizeKey = "FirstMinimizeNotificationShown";

/// <summary>
/// Indicates whether the tray/hotkey notification has already been shown.
/// </summary>
public static bool FirstMinimizeNotificationShown
{
    get
    {
        try
        {
            var settings = ApplicationData.Current.LocalSettings;
            if (settings.Values.TryGetValue(FirstMinimizeKey, out var val) && val is bool b)
            {
                return b;
            }
        }
        catch { }
        return false;
    }
    set
    {
        try
        {
            var settings = ApplicationData.Current.LocalSettings;
            settings.Values[FirstMinimizeKey] = value;
        }
        catch { }
    }
}
```

#### Step 2: Add MessageBox Interop
- [x] Open `ResizeMe/Native/WindowsApi.cs`
- [ ] Near other P/Invoke declarations add:

```csharp
[DllImport("user32.dll", CharSet = CharSet.Unicode)]
public static extern int MessageBoxW(IntPtr hWnd, string lpText, string lpCaption, uint uType);

public const uint MB_OK = 0x00000000; // Using simple OK button
```

#### Step 3: Trigger Notification on First Hide
- [x] Open `ResizeMe/MainWindow.xaml.cs`
- [ ] In `HideWindow()` after setting `_isVisible = false;` add:

```csharp
// First minimize tray notification
try
{
    if (!Services.UserPreferences.FirstMinimizeNotificationShown)
    {
        string hotkey = "Win+Shift+F12"; // Will be dynamic in Step 4
        var message = $"ResizeMe is running in the system tray. Right-click the tray icon for Settings or Exit. Press {hotkey} to open the quick resize window.";
        WindowsApi.MessageBoxW(_windowHandle, message, "ResizeMe Running", WindowsApi.MB_OK);
        Services.UserPreferences.FirstMinimizeNotificationShown = true;
    }
}
catch (Exception ex)
{
    System.Diagnostics.Debug.WriteLine($"First minimize notification error: {ex.Message}");
}
```

- [x] Save all modified files
- [x] `dotnet build ResizeMe.sln`
- [ ] Run app -> perform initial toggle/hide (hotkey or close button) -> message box appears once
- [ ] Hide again -> message does not reappear
- [ ] Delete local settings (optional) -> verify message reappears on next first hide

## Verification Checklist

- [x] Preference flag added and persists
- [ ] Message box appears only on first hide
- [x] Text includes correct hotkey placeholder (will update in Step 4)

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Message appears every hide | Confirm flag set to true after MessageBox call |
| Message never appears | Ensure logic placed after `_isVisible = false;` and `_windowHandle` valid |
| Build error on MessageBoxW | Check CharSet=Unicode and parameter list matches snippet |
| Null handle in MessageBox | Ensure `_windowHandle` is set earlier via `EnsureWindowHandle()` |

## Files Modified

- [x] ✅ Modified: `ResizeMe/Services/UserPreferences.cs`
- [x] ✅ Modified: `ResizeMe/Native/WindowsApi.cs`
- [x] ✅ Modified: `ResizeMe/MainWindow.xaml.cs`

## What Comes Next

- Proceed to Step 4: Hotkey customization (dynamic display will replace hardcoded string).
