# Step 4.1: Hotkey Preferences & Manager Update

**Part of:** Step 4 from plan.md  
**Focus:** Store dynamic hotkey (modifiers + key) in preferences and adapt `HotKeyManager` to register from stored values with basic normalization.  
**Files to Edit:** `ResizeMe/Services/UserPreferences.cs`, `ResizeMe/Services/HotKeyManager.cs`, `ResizeMe/MainWindow.xaml.cs`  
**Estimated Time:** 15 minutes

## Overview
Adds persistent hotkey properties and refactors `HotKeyManager` to consume them instead of hardcoded Win+Shift+F12. This lays groundwork for UI customization (Step 4.2).

## Pre-Substep Checklist

- [ ] **Branch:** `system-tray-integration`
- [ ] **Prior Steps:** 1–3 complete
- [ ] **Build OK:** `dotnet build ResizeMe.sln`

## Implementation

### Goal
Support dynamic registration of a user-configurable global hotkey defined by saved modifier and key fields.

### Step-by-Step Instructions

#### Step 1: Add Hotkey Preference Fields
- [ ] Open `ResizeMe/Services/UserPreferences.cs`
- [ ] Below previous properties add:

```csharp
private const string HotKeyModifiersKey = "HotKeyModifiers"; // e.g. WIN+SHIFT
private const string HotKeyCodeKey = "HotKeyKey";           // e.g. F12

/// <summary>
/// Hotkey modifier list (canonical upper-case plus-separated: CTRL+ALT+SHIFT+WIN).
/// </summary>
public static string HotKeyModifiers
{
    get
    {
        try
        {
            var s = Windows.Storage.ApplicationData.Current.LocalSettings;
            if (s.Values.TryGetValue(HotKeyModifiersKey, out var val) && val is string str && !string.IsNullOrWhiteSpace(str))
            {
                return str.ToUpperInvariant();
            }
        }
        catch { }
        return "WIN+SHIFT"; // default
    }
    set
    {
        try
        {
            var s = Windows.Storage.ApplicationData.Current.LocalSettings;
            s.Values[HotKeyModifiersKey] = value.ToUpperInvariant();
        }
        catch { }
    }
}

/// <summary>
/// Hotkey primary key (single token, e.g. F12, R, 1).
/// </summary>
public static string HotKeyCode
{
    get
    {
        try
        {
            var s = Windows.Storage.ApplicationData.Current.LocalSettings;
            if (s.Values.TryGetValue(HotKeyCodeKey, out var val) && val is string str && !string.IsNullOrWhiteSpace(str))
            {
                return str.ToUpperInvariant();
            }
        }
        catch { }
        return "F12"; // default
    }
    set
    {
        try
        {
            var s = Windows.Storage.ApplicationData.Current.LocalSettings;
            s.Values[HotKeyCodeKey] = value.ToUpperInvariant();
        }
        catch { }
    }
}
```

#### Step 2: Refactor HotKeyManager for Dynamic Values
- [ ] Open `ResizeMe/Services/HotKeyManager.cs`
- [ ] Replace `RegisterHotKey()` with dynamic logic:

```csharp
public bool RegisterHotKey()
{
    if (_isRegistered) return true;
    if (_windowHandle == IntPtr.Zero) return false;

    try
    {
        // Build modifier mask
        uint modMask = 0;
        var mods = Services.UserPreferences.HotKeyModifiers.Split('+', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var m in mods)
        {
            switch (m.ToUpperInvariant())
            {
                case "CTRL": modMask |= Native.WindowsApi.MOD_CONTROL; break;
                case "ALT": modMask |= Native.WindowsApi.MOD_ALT; break;
                case "SHIFT": modMask |= Native.WindowsApi.MOD_SHIFT; break;
                case "WIN": modMask |= Native.WindowsApi.MOD_WIN; break;
            }
        }
        if (modMask == 0) modMask = Native.WindowsApi.MOD_WIN; // Safety fallback

        // Key translation (supports F-keys and letters/numbers)
        string keyToken = Services.UserPreferences.HotKeyCode.ToUpperInvariant();
        uint vk = TranslateKeyToken(keyToken);

        bool success = Native.WindowsApi.RegisterHotKey(_windowHandle, HOTKEY_ID, modMask, vk);
        if (success)
        {
            _isRegistered = true;
            System.Diagnostics.Debug.WriteLine($"HotKeyManager: Registered {Services.UserPreferences.HotKeyModifiers}+{Services.UserPreferences.HotKeyCode}");
        }
        else
        {
            int errorCode = Marshal.GetLastWin32Error();
            System.Diagnostics.Debug.WriteLine($"HotKeyManager: Failed to register dynamic hotkey. Win32Error: {errorCode}");
        }
        return success;
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"HotKeyManager: Exception during dynamic hotkey registration: {ex.Message}");
        return false;
    }
}

private static uint TranslateKeyToken(string token)
{
    if (token.StartsWith("F") && int.TryParse(token.Substring(1), out int fNum) && fNum >= 1 && fNum <= 24)
    {
        return (uint)(0x70 + (fNum - 1)); // VK_F1=0x70
    }
    if (token.Length == 1)
    {
        char c = token[0];
        if (c >= '0' && c <= '9') return (uint)c; // digits map directly
        if (c >= 'A' && c <= 'Z') return (uint)c; // letters map directly
    }
    // fallback F12
    return Native.WindowsApi.VK_F12;
}
```

#### Step 3: Display Dynamic Hotkey in MainWindow Status (Optional Now)
- [ ] In `EnsureHotKeyRegistration()` after successful registration set:

```csharp
StatusText.Text = $"Ready ({Services.UserPreferences.HotKeyModifiers}+{Services.UserPreferences.HotKeyCode})";
```

#### Step 4: Build & Verify
- [ ] Save files
- [ ] `dotnet build ResizeMe.sln`
- [ ] (Optional) Temporarily set `UserPreferences.HotKeyModifiers = "CTRL+ALT"; UserPreferences.HotKeyCode = "R";` before registration to test alternate hotkey.
- [ ] Run app -> press new combination -> window toggles

## Verification Checklist

- [ ] Preferences default to WIN+SHIFT+F12
- [ ] Changing stored modifiers/key re-registers dynamic hotkey on next launch
- [ ] Hotkey triggers toggle

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Hotkey not triggering | Confirm mask built includes at least one modifier; ensure registration success logged |
| Registration fails (1409) | Combination in use by another app; choose different key/mods |
| Wrong key mapping | Check `TranslateKeyToken` logic; F-key ranges 1–24 supported |
| Status displays default only | Ensure you saved new values before `EnsureHotKeyRegistration()` call |

## Files Modified

- [ ] ✅ Modified: `ResizeMe/Services/UserPreferences.cs`
- [ ] ✅ Modified: `ResizeMe/Services/HotKeyManager.cs`
- [ ] ✅ Modified: `ResizeMe/MainWindow.xaml.cs`

## What Comes Next

- Next substep: Step 4.2 - UI for customizing hotkey & reserved hotkey validation logic.
